---
title: |
  | Introduction to the Design and Analysis of Randomized Experiments
  | Class 2: Estimators and Tests, Randomization-Based Statistical Inference
date: '`r format(Sys.Date(), "%B %d, %Y")`'
author: Jake Bowers
bibliography:
 - ../course.bib
fontsize: 10pt
graphics: yes
biblio-style: authoryear-comp
link-citations: true
biblatexoptions:
  - natbib=true
header-includes: |
  \setbeameroption{hide notes}
  \usepackage{hyperref}
  \usepackage{bookmark}
  \setbeamertemplate{footline}{\begin{beamercolorbox}{section in head/foot}
  \insertframenumber/\inserttotalframenumber \end{beamercolorbox}}
  \setbeamertemplate{itemize item}[circle]
  \setbeamertemplate{itemize subitem}[triangle]
  \setbeamertemplate{itemize subitem}{\raisebox{0.2em}{\scalebox{1}{$\blacktriangleright$}}}
  \setbeamersize{description width=2ex}
  \setbeamersize{text margin left=1ex,text margin right=1ex}
  \usepackage{tikz}
  \usepackage{tikz-cd}
  \usepackage{textpos}
  \usepackage{booktabs,multirow,makecell}
  \usepgflibrary{arrows}
  \usetikzlibrary{arrows}
  \tikzstyle{every picture}+=[remember picture]
  \newcommand{\theHtable}{\thetable}
  \usepackage{amsmath,amsthm}
output:
  beamer_presentation:
    slide_level: 2
    keep_tex: true
    toc: true
    latex_engine: lualatex
    citation_package: biblatex
    incremental: false
    md_extensions: +raw_attribute-tex_math_single_backslash+autolink_bare_uris+ascii_identifiers+tex_math_dollars
    pandoc_args: [ "--csl", "chicago-author-date.csl", "--toc" ]
colorlinks: true
---


<!-- To show notes  -->
<!-- https://stackoverflow.com/questions/44906264/add-speaker-notes-to-beamer-presentations-using-rmarkdown -->

```{r echo=FALSE, include=TRUE, cache=FALSE}
library(here)
source(here::here("Exercises/rmd_setup.R"))
library(tidyverse)
library(DeclareDesign)
library(coin)
library(kableExtra)
```

```{r setup2, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

## from https://bookdown.org/yihui/rmarkdown-cookbook/font-color.html
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf(
      "<span style='color: %s;'>%s</span>", color,
      x
    )
  } else {
    x
  }
}
```

# Overview and Review

##  Today

  0. Quiz and Questions
  1. Some randomized designs: simple (coin flipping), complete (urn-drawing),
     factorial, blocked or stratified, clustered.
  2. Statistical inference for causal effects in randomized experiments via the
     Fisher and Neyman approaches \autocite[Chap 2]{rosenbaum2010},
     \autocite[Chap 1-3]{gerbergreen2012}: Estimation, Estimators, Tests,
     Testing. Also Statistical Power.

Note: You can download (and contribute to) course materials at [https://github.com/bowers-illinois-edu/short_course_experiments](https://github.com/bowers-illinois-edu/short_course_experiments)

Hay recursos en español aqui: <https://egap.github.io/theory_and_practice_of_field_experiments_spanish/>

## Quiz

 - What are key features of a randomized experiment? (What would we need to see
   in a research design to call it a randomized experiment?)
 - Why would social scientists want to use a randomized experiment?
 - Why would policy makers want to use a randomized experiment?
 - Someone says a confusing statement, "I love experiments in my studies
   because I know that the treatment group income is exactly the same as the
   control group income. Plus I randomize so I know that my groups are
   representative." (What is wrong with this statement? How to help this person
   say it better? Como debemos hablar de covariables y lo que garantiza un
   experimento aleatorio y lo que no garantiza.)
 - Why would we like randomized experiments to have large N? (People often say
   "large samples" but often my experiments are not samples, they are the whole
   population, or a just a set of people with no sampling.)
 - Say we have some baseline data including covariates like income. If we randomize in a simple
 - When I write, "Each person has two potential outcomes, $Y_i(T_i=1),
   Y_i(T_i=0)$" what am I assuming?

## Lingering Questions?

Questions arising?

# Some Randomized Designs

## Simple randomization (coin-flipping)

- For each unit, flip a coin to see if it will be treated. Then you measure outcomes at the same level as the coin.

- The coins don’t have to be fair (50-50), but you have to know the probability of treatment assignment.

- You can’t guarantee a specific number of treated units and control units.

- Example: If you have 6 units and you flip a fair coin for each, you have about a 3% chance of assigning **all** units to treatment or assigning **all** units to control.

## Example code for simple randomization I

```{r echo=TRUE}
# set the random number seed to make this replicable
set.seed(12345)

# set a sample size
N <- 200

# Generate the simple random assignment
# (Notice that in an experiment we have a single
# trial and thus size=1)
# Our object with N people total is called simple.ra
simple.ra <- rbinom(n = N, size = 1, prob = .5)

# 112 people ended up in the treatment group
sum(simple.ra)
```

## Example code for simple randomization II

```{r echo=TRUE}
# you can also use the randomizr package
library(randomizr)

# for replicability
set.seed(23456)
# Simple random assignment uses the simple_ra function
# Our object with N people total is called treatment
treatment <- simple_ra(
  N = N, # total sample size
  prob = .5 # probability of receiving treatment
)
sum(treatment)
```

## Complete randomization (drawing from an urn)

- A fixed number $m$ out of $N$ units are assigned to treatment.

- The probability a unit is assigned to treatment is $m/N$.

- This is like having an urn or bowl or bag with $N$ balls, of which $m$ are marked as treatment and $N-m$ are marked as control.  Public lotteries use this method.

## Example code for complete randomization I

``` {r echo=TRUE}
# set sample size N
N <- 200
# set number of treated units m
m <- 100

# create a vector of m 1's and N-m 0's
complete.ra <- c(rep(1, m), rep(0, N - m))

# And then scramble it randomly using sample()
# The default is sampling without replacement

set.seed(12345) # for replicability
complete.ra <- sample(complete.ra)

sum(complete.ra)
```

## Example code for complete randomization II

``` {r echo=TRUE}
# you can also use the randomizr package
library(randomizr)

# for replicability
set.seed(23456)

# Complete random assignment:
treatment <- complete_ra(
  N = 200, # total sample size
  m = 100
) # number to assign to treatment

sum(treatment)

# note what happens if you don't specify m!
```

Should always give you $m$ treated.

## Block (or stratified) randomization I

- We create blocks of units and randomize separately within each block. We are doing mini-experiments in each block.

  - Example: block = district, units = communities.  We randomize treatment at the community level **within district** and also measure outcomes at the community level.

- Blocks that represent a substantively meaningful subgroup can help you to
  learn about how effects might differ by subgroup.

    - By controlling number of subjects per subgroup, you ensure that you have
    enough subjects in each group.

    - Especially useful when you have a rare group --- by chance you might get
    very few of them in treatment or control even under random assignment (or
    you might have some imbalance).

## Block (or stratified) randomization II

- Blocks that are homogeneous on a given outcome increase precision of
  estimation for that outcome as compared with the experiment without blocks. (We
  will address this more in the power analysis section).

## Example code for block or stratified randomization

``` {r echo=TRUE}
# for replicability
set.seed(23456)

dat <- data.frame(block = rep(c(1, 2), each = 10))

# Complete random assignment:
dat$treatment <- block_ra(blocks = dat$block, m = 3)

with(dat, table(block, treatment, useNA = "ifany"))
```

## Cluster randomization I

- A cluster is a **group of units**. In a cluster-randomized study, all units in the cluster are assigned to the same treatment status.

- Use cluster randomization if the intervention has to work at the cluster level.

  - For example, if the intervention is about school playgrounds, then the school is the unit of assignment even if student health may be an outcome measured at level of individual students.

- Having fewer clusters hurts your ability to detect treatment effects and make
  cause misleading $p$-values and confidence intervals (or even estimates).
  *How much* depends on the intra-cluster correlation (ICC or $\rho$).

## Cluster randomization II

- Higher $\rho$ is worse:

    - When $\rho=0$ then the village doesn't matter for the behavior of the individuals.
    - When $\rho=1$ then every person in the village would give exactly the same answer.  Having another person from this village doesn't give you additional information since his outcome is identical to the person you already had.

- For the same number of units, having **more clusters** with fewer units per cluster can help.

- Trade off spillover and power.

- If you would not like an experiment with 10 units, then you should not be
      happy with an experiment with 10 clusters of 100 units. The effective sample size of this cluster randomized experiment is between 10 and 10 $\times$ 100 = 1000, but closer to 10 the higher the $\rho$.


## Example code for clustered randomization

``` {r echo=TRUE}
# for replicability
set.seed(23456)

dat <- data.frame(cluster = rep(seq(1, 10), each = 3))

# Complete random assignment:
dat$treatment <- cluster_ra(clusters = dat$cluster, m = 3)

## 3 people in each cluster, all assigned to the same treatment
with(dat, table(cluster, treatment, useNA = "ifany"))
```

## You can combine blocks and clusters

- You can have clusters within blocks.

  - Example: block = district, cluster = communities, units = individuals.  You are measuring outcomes at the individual level.

  - Example: block = province, cluster = district, units = communities.  You are measuring outcomes at the community level.

- You can't have blocks within clusters.

- For block and cluster randomization, you can use `block_ra` and `cluster_ra` in the `randomizr` package in R.

- For more complicated designs, you might find `DeclareDesign` helpful. (<https://declaredesign.org>)

## Examples of randomization implementation:  Random Access

  - Randomly select a treatment group through a lottery or equivalent
    mechanism, which randomizes **access** to the program.

  - Useful when you do not have enough resources to treat everyone.

  - Sometimes, some units (peoples, communities) must have access to a program.
     - For example: a partner organization doesn’t want to risk a vulnerable
       community NOT getting a program (want a guarantee that they will be
       always be treated).
     - You can exclude those units from the experiment, and do random
       assignment among the remaining units that have a probability of
       assignment strictly between (and not including) 0 and 1.

## Delayed access (Phase-in or wait list)

- Randomize *timing* of access to the program.

- Often you do not have the capacity to implement the treatment in a lot of
  places at once and/or you cannot completely exclude people from the
  treatment.

- When an intervention can be or must be rolled out in stages, you can
  randomize **the order** in which units are treated.

- Your control group are the as-yet untreated units.

- Be careful: the probability of assignment to treatment will vary over time
  because units that are assigned to treatment in earlier stages are not
  eligible to be assigned to treatment in later stages.


## Factorial or crossed-assignment

- Factorial design enables testing of more than one treatment.

- You can analyze one treatment at a time.

- Or combinations thereof.

- Example:

\begin{table}
\begin{tabular}{r|c|c}
 & $X_1=0$ & $X_1=1$ \\ \hline
$X_2=1$ & A  & C  \\ \hline
$X_2=0$ & B  & D  \\
\hline
\end{tabular}
\end{table}

We might focus on an estimand like  $\mathbb{E}[Y(X_1=1, X_2=1)]-\mathbb{E}[Y(X_1=0, X_2=0)]$.

## Example code for factorial randomization

See <https://egap.org/resource/10-things-to-know-about-randomization/>

```{r}
dat <- data.frame(id = 1:20)

dat$treatment_1 <- complete_ra(N = 20, m = 10)
dat$treatment_2 <- block_ra(blocks = dat$treatment_1)
with(dat, table(treatment_1, treatment_2))
```

## Encouragement

- Randomize **encouragement** to take the treatment, such as an invitation or subsidy to participate in a program.

- Useful when you cannot force a subject to participate.

- Estimands:
    - the ATE of the encouragement for your experimental sample.

    - the ATE of participation (not the encouragement) for the units who would participate when encouraged and wouldn't participate when not encouraged (compliers).

- Instrumental variables analysis for the complier ATE, with the assignment as the instrument.  Note the exclusion restriction.


## Best practices in randomization: replicability

- EGAP Methods Guide on Randomization (<https://egap.org/resource/10-things-to-know-about-randomization/>)

- Set a seed and save your code and random assignment column

- Verify

- Sometimes increased transparency > replicability


## Best practices in randomization: balance

- Check overall balance with a D-square test using `balanceTest` in the `RItools` package (@hansen:bowers:2008) (large sample randomization inference):

```{r echo=TRUE, eval=FALSE}
balanceTest(treatment ~ x1 + x2, data = dat)
```
  -  See also the `coin` package `independence_test` for permutation based version with `independence_test(x1+x2~treatment,data=dat,distribution=approximate(...))`

- Use an F-test for a regression of treatment assignment on LHS and covariates on RHS (large sample approximate to randomization inference):

```{r echo=TRUE, eval=FALSE}
anova(lm(treatment ~ 1, data = dat),
  lm(treatment ~ x1 + x2 + x3, data = dat),
  test = "F"
)
```

## Best practices in randomization: balance

  - Random assignment gives us, in expectation, **overall balance** on the many
    covariates. It does not guarantee that all covariate to treatment
    relationships will be zero. In fact, in a small experiment, the magnitudes
    of imbalance may be high even if the randomization occurred perfectly.

  - You will see t-tests of covariates one by one.  Just by chance, you might
    get statistically significant differences on a variable. If you check
    balance on 100 variables, you will reject the null of no relationship in 5
    of them even if there truly is no relationship.

  - A small $p$-value from an omnibus balance test is like a **screener** for
    errors in the administration of the experiment or maybe in the
    randomization code.  It doesn't mean that the experiment was broken.
# Testing

# Statistical Power

# Estimation

# Appendix

## References

